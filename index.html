<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Å–≤—ñ—Ç–Ω—è –≥—Ä–∞ "–î—É–º–∞–π –Ω–∞ —Ä—ñ–≤–Ω–∏—Ö"</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 700px;
            width: 100%;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        h1 {
            color: #4a5568;
            font-size: clamp(1.3em, 3.5vw, 2.2em);
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            line-height: 1.2;
        }
        
        .menu-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .menu-btn {
            background: linear-gradient(145deg, #4299e1, #3182ce);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px;
            font-size: clamp(1.1em, 3vw, 1.4em);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            touch-action: manipulation;
        }
        
        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .menu-btn.emotions { background: linear-gradient(145deg, #48bb78, #38a169); }
        .menu-btn.alphabet { background: linear-gradient(145deg, #ed8936, #dd6b20); }
        .menu-btn.numbers { background: linear-gradient(145deg, #9f7aea, #805ad5); }
        .menu-btn.drawing { background: linear-gradient(145deg, #f56565, #e53e3e); }
        .menu-btn.letter-drawing { background: linear-gradient(145deg, #667eea, #764ba2); }
        .menu-btn.free-drawing { background: linear-gradient(145deg, #a3a3a3, #7a7a7a); } 
        
        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .display-area {
            font-size: clamp(4em, 15vw, 8em);
            margin: 20px 0;
            animation: bounce 2s infinite;
            line-height: 1;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer; /* Add cursor pointer for clickable elements */
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .question {
            font-size: clamp(1.1em, 3vw, 1.5em);
            color: #2d3748;
            margin-bottom: 20px;
            font-weight: bold;
            line-height: 1.3;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .option-btn {
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            padding: 15px 10px;
            font-size: clamp(1em, 2.5vw, 1.2em);
            font-weight: bold;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-wrap: break-word;
        }
        
        .option-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
            background: linear-gradient(145deg, #e2e8f0, #cbd5e0);
        }
        
        .option-btn.correct {
            background: linear-gradient(145deg, #68d391, #48bb78);
            color: white;
            border-color: #38a169;
        }
        
        .option-btn.wrong {
            background: linear-gradient(145deg, #fc8181, #f56565);
            color: white;
            border-color: #e53e3e;
        }
        
        .score {
            font-size: clamp(1.1em, 3vw, 1.3em);
            color: #4a5568;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            background: linear-gradient(145deg, #4299e1, #3182ce);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 12px 24px;
            font-size: clamp(1em, 2.5vw, 1.2em);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            min-height: 50px;
            touch-action: manipulation;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .btn.back { background: linear-gradient(145deg, #718096, #4a5568); }
        .btn.restart { background: linear-gradient(145deg, #38a169, #2f855a); }
        .btn.undo { background: linear-gradient(145deg, #9f7aea, #805ad5); } 
        .btn.redo { background: linear-gradient(145deg, #f06292, #ec407a); } 

        .feedback {
            font-size: clamp(1.1em, 3vw, 1.4em);
            font-weight: bold;
            margin: 15px 0;
            padding: 12px;
            border-radius: 10px;
            line-height: 1.3;
        }
        
        .feedback.correct {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .feedback.wrong {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .final-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
        }
        
        .final-score h2 {
            font-size: clamp(1.3em, 4vw, 2em);
            margin-bottom: 10px;
        }
        
        .final-score p {
            font-size: clamp(1em, 2.5vw, 1.2em);
            margin: 8px 0;
            line-height: 1.4;
        }
        
        /* –ö–∞–Ω–≤–∞—Å –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è */
        .drawing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        #drawingCanvas, #letterDrawingCanvas, #freeDrawingCanvas { 
            border: 3px solid #4299e1;
            border-radius: 15px;
            background: white;
            cursor: crosshair;
            touch-action: none; 
        }
        
        .drawing-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .color-btn {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .color-btn.active {
            border-color: #4299e1;
            transform: scale(1.2);
        }

        .tool-controls { 
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tool-btn {
            background: #edf2f7;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 15px; 
            font-size: clamp(1em, 2.5vw, 1.4em); 
            width: 50px; 
            height: 50px; 
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            font-weight: bold;
        }

        .tool-btn:hover {
            background: #cbd5e0;
            transform: translateY(-1px);
        }

        .tool-btn.active {
            background: #4299e1;
            color: white;
            border-color: #3182ce;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .number-practice, .letter-practice, .free-drawing-mode { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .number-display, .letter-display-draw {
            font-size: clamp(6em, 20vw, 12em);
            color: #4299e1;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .trace-instruction {
            font-size: clamp(1em, 2.5vw, 1.3em);
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        /* –ú–æ–±—ñ–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .game-container {
                padding: 15px;
                border-radius: 15px;
                min-height: 90vh;
            }
            
            .options {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .menu-container {
                gap: 12px;
            }
            
            .menu-btn {
                padding: 15px;
            }
            
            #drawingCanvas, #letterDrawingCanvas, #freeDrawingCanvas {
                width: 100%;
                max-width: 300px;
                height: 200px;
            }

            .drawing-controls, .tool-controls {
                gap: 5px;
            }

            .color-btn {
                width: 35px;
                height: 35px;
            }

            .tool-btn {
                width: 45px;
                height: 45px;
                font-size: clamp(0.9em, 2.2vw, 1.2em);
            }
        }
        
        /* –ü–ª–∞–Ω—à–µ—Ç–∏ */
        @media (min-width: 481px) and (max-width: 768px) {
            .options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            #drawingCanvas, #letterDrawingCanvas, #freeDrawingCanvas {
                width: 400px;
                height: 300px;
            }

            .tool-btn {
                width: 55px;
                height: 55px;
            }
        }
        
        /* –í–µ–ª–∏–∫—ñ –µ–∫—Ä–∞–Ω–∏ */
        @media (min-width: 769px) {
            .options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            #drawingCanvas, #letterDrawingCanvas, #freeDrawingCanvas {
                width: 500px;
                height: 400px;
            }

            .tool-btn {
                width: 60px;
                height: 60px;
            }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üéÆ –î—É–º–∞–π –Ω–∞ —Ä—ñ–≤–Ω–∏—Ö</h1>
        
        <div id="main-menu" class="menu-container">
            <button class="menu-btn emotions" onclick="startGame('emotions')">
                üòä –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –µ–º–æ—Ü—ñ–π
            </button>
            <button class="menu-btn alphabet" onclick="startGame('alphabet')">
                üî§ –í–∏–≤—á–µ–Ω–Ω—è –∞–ª—Ñ–∞–≤—ñ—Ç—É
            </button>
            <button class="menu-btn numbers" onclick="startGame('numbers')">
                üî¢ –í–∏–≤—á–µ–Ω–Ω—è —Ü–∏—Ñ—Ä
            </button>
            <button class="menu-btn drawing" onclick="startGame('drawing')">
                ‚úèÔ∏è –ú–∞–ª—é–≤–∞–Ω–Ω—è —Ü–∏—Ñ—Ä
            </button>
            <button class="menu-btn letter-drawing" onclick="startGame('letter-drawing')">
                ‚úçÔ∏è –ú–∞–ª—é–≤–∞–Ω–Ω—è –ª—ñ—Ç–µ—Ä
            </button>
            <button class="menu-btn free-drawing" onclick="startGame('free-drawing')">
                üé® –í—ñ–ª—å–Ω–µ –º–∞–ª—é–≤–∞–Ω–Ω—è
            </button>
        </div>
        
        <div id="emotions-game" class="game-content hidden">
            <div class="score">
                –†–∞—Ö—É–Ω–æ–∫: <span id="emotions-score">0</span> / <span id="emotions-total">0</span>
            </div>
            
            <div class="display-area" id="emotion-emoji">üòä</div>
            <div class="question">–Ø–∫–∞ —Ü–µ –µ–º–æ—Ü—ñ—è?</div>
            
            <div class="options" id="emotions-options"></div>
            
            <div id="emotions-feedback" class="feedback hidden"></div>
            
            <div class="controls">
                <button class="btn back" onclick="showMenu()">üè† –ú–µ–Ω—é</button>
                <button id="emotions-next" class="btn hidden" onclick="nextQuestion()">–î–∞–ª—ñ</button>
            </div>
        </div>
        
        <div id="alphabet-game" class="game-content hidden">
            <div class="score">
                –†–∞—Ö—É–Ω–æ–∫: <span id="alphabet-score">0</span> / <span id="alphabet-total">0</span>
            </div>
            
            <div class="display-area" id="letter-display" onclick="speakText(this.textContent)">–ê</div>
            <div class="question">–Ø–∫–∞ —Ü–µ –ª—ñ—Ç–µ—Ä–∞?</div>
            
            <div class="options" id="alphabet-options"></div>
            
            <div id="alphabet-feedback" class="feedback hidden"></div>
            
            <div class="controls">
                <button class="btn back" onclick="showMenu()">üè† –ú–µ–Ω—é</button>
                <button id="alphabet-next" class="btn hidden" onclick="nextQuestion()">–î–∞–ª—ñ</button>
            </div>
        </div>
        
        <div id="numbers-game" class="game-content hidden">
            <div class="score">
                –†–∞—Ö—É–Ω–æ–∫: <span id="numbers-score">0</span> / <span id="numbers-total">0</span>
            </div>
            
            <div class="display-area" id="number-display" onclick="speakText(this.textContent)">1</div>
            <div class="question">–Ø–∫–∞ —Ü–µ —Ü–∏—Ñ—Ä–∞?</div>
            
            <div class="options" id="numbers-options"></div>
            
            <div id="numbers-feedback" class="feedback hidden"></div>
            
            <div class="controls">
                <button class="btn back" onclick="showMenu()">üè† –ú–µ–Ω—é</button>
                <button id="numbers-next" class="btn hidden" onclick="nextQuestion()">–î–∞–ª—ñ</button>
            </div>
        </div>
        
        <div id="drawing-game" class="game-content hidden">
            <div class="number-practice">
                <div class="trace-instruction">–ù–∞–º–∞–ª—é–π —Ü–∏—Ñ—Ä—É:</div>
                <div class="number-display" id="draw-number" onclick="speakText(this.textContent)">1</div>
                
                <div class="drawing-container">
                    <canvas id="drawingCanvas" width="500" height="400"></canvas>
                    
                    <div class="drawing-controls">
                        <div class="color-btn active" style="background: #000" data-color="#000000" data-canvas="drawingCanvas"></div>
                        <div class="color-btn" style="background: #FF0000" data-color="#FF0000" data-canvas="drawingCanvas"></div> 
                        <div class="color-btn" style="background: #00FF00" data-color="#00FF00" data-canvas="drawingCanvas"></div> 
                        <div class="color-btn" style="background: #0000FF" data-color="#0000FF" data-canvas="drawingCanvas"></div> 
                        <div class="color-btn" style="background: #FFFF00" data-color="#FFFF00" data-canvas="drawingCanvas"></div> 
                        <div class="color-btn" style="background: #FF00FF" data-color="#FF00FF" data-canvas="drawingCanvas"></div> 
                        <div class="color-btn" style="background: #00FFFF" data-color="#00FFFF" data-canvas="drawingCanvas"></div> 
                        <div class="color-btn" style="background: #FFA500" data-color="#FFA500" data-canvas="drawingCanvas"></div> 
                        <div class="color-btn" style="background: #800080" data-color="#800080" data-canvas="drawingCanvas"></div> 
                    </div>
                    <div class="tool-controls">
                        <button class="tool-btn active" data-tool="pen" data-canvas="drawingCanvas">üñäÔ∏è</button>
                        <button class="tool-btn" data-tool="eraser" data-canvas="drawingCanvas">üßΩ</button>
                        <button class="tool-btn" data-size="3" data-canvas="drawingCanvas">‚ö™</button>
                        <button class="tool-btn active" data-size="5" data-canvas="drawingCanvas">üîµ</button>
                        <button class="tool-btn" data-size="10" data-canvas="drawingCanvas">üî¥</button>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn back" onclick="showMenu()">üè† –ú–µ–Ω—é</button>
                    <button class="btn" onclick="clearCanvas('number')">üóëÔ∏è</button>
                    <button class="btn undo" onclick="undoCanvas('number')">‚Ü©Ô∏è</button>
                    <button class="btn redo" onclick="redoCanvas('number')">‚Ü™Ô∏è</button>
                    <button class="btn" onclick="nextDrawingItem('number')">‚û°Ô∏è</button>
                </div>
            </div>
        </div>

        <div id="letter-drawing-game" class="game-content hidden">
            <div class="letter-practice">
                <div class="trace-instruction">–ù–∞–º–∞–ª—é–π –ª—ñ—Ç–µ—Ä—É:</div>
                <div class="letter-display-draw" id="draw-letter" onclick="speakText(this.textContent)">–ê</div>
                
                <div class="drawing-container">
                    <canvas id="letterDrawingCanvas" width="500" height="400"></canvas>
                    
                    <div class="drawing-controls">
                        <div class="color-btn active" style="background: #000" data-color="#000000" data-canvas="letterDrawingCanvas"></div>
                        <div class="color-btn" style="background: #FF0000" data-color="#FF0000" data-canvas="letterDrawingCanvas"></div>
                        <div class="color-btn" style="background: #00FF00" data-color="#00FF00" data-canvas="letterDrawingCanvas"></div>
                        <div class="color-btn" style="background: #0000FF" data-color="#0000FF" data-canvas="letterDrawingCanvas"></div>
                        <div class="color-btn" style="background: #FFFF00" data-color="#FFFF00" data-canvas="letterDrawingCanvas"></div>
                        <div class="color-btn" style="background: #FF00FF" data-color="#FF00FF" data-canvas="letterDrawingCanvas"></div>
                        <div class="color-btn" style="background: #00FFFF" data-color="#00FFFF" data-canvas="letterDrawingCanvas"></div>
                        <div class="color-btn" style="background: #FFA500" data-color="#FFA500" data-canvas="letterDrawingCanvas"></div>
                        <div class="color-btn" style="background: #800080" data-color="#800080" data-canvas="letterDrawingCanvas"></div>
                    </div>
                    <div class="tool-controls">
                        <button class="tool-btn active" data-tool="pen" data-canvas="letterDrawingCanvas">üñäÔ∏è</button>
                        <button class="tool-btn" data-tool="eraser" data-canvas="letterDrawingCanvas">üßΩ</button>
                        <button class="tool-btn" data-size="3" data-canvas="letterDrawingCanvas">‚ö™</button>
                        <button class="tool-btn active" data-size="5" data-canvas="letterDrawingCanvas">üîµ</button>
                        <button class="tool-btn" data-size="10" data-canvas="letterDrawingCanvas">üî¥</button>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn back" onclick="showMenu()">üè† –ú–µ–Ω—é</button>
                    <button class="btn" onclick="clearCanvas('letter')">üóëÔ∏è</button>
                    <button class="btn undo" onclick="undoCanvas('letter')">‚Ü©Ô∏è</button>
                    <button class="btn redo" onclick="redoCanvas('letter')">‚Ü™Ô∏è</button>
                    <button class="btn" onclick="nextDrawingItem('letter')">‚û°Ô∏è</button>
                </div>
            </div>
        </div>

        <div id="free-drawing-game" class="game-content hidden">
            <div class="free-drawing-mode">
                <div class="drawing-container">
                    <canvas id="freeDrawingCanvas" width="500" height="400"></canvas>
                    
                    <div class="drawing-controls">
                        <div class="color-btn active" style="background: #000" data-color="#000000" data-canvas="freeDrawingCanvas"></div>
                        <div class="color-btn" style="background: #FF0000" data-color="#FF0000" data-canvas="freeDrawingCanvas"></div>
                        <div class="color-btn" style="background: #00FF00" data-color="#00FF00" data-canvas="freeDrawingCanvas"></div>
                        <div class="color-btn" style="background: #0000FF" data-color="#0000FF" data-canvas="freeDrawingCanvas"></div>
                        <div class="color-btn" style="background: #FFFF00" data-color="#FFFF00" data-canvas="freeDrawingCanvas"></div>
                        <div class="color-btn" style="background: #FF00FF" data-color="#FF00FF" data-canvas="freeDrawingCanvas"></div>
                        <div class="color-btn" style="background: #00FFFF" data-color="#00FFFF" data-canvas="freeDrawingCanvas"></div>
                        <div class="color-btn" style="background: #FFA500" data-color="#FFA500" data-canvas="freeDrawingCanvas"></div>
                        <div class="color-btn" style="background: #800080" data-color="#800080" data-canvas="freeDrawingCanvas"></div>
                    </div>
                    <div class="tool-controls">
                        <button class="tool-btn active" data-tool="pen" data-canvas="freeDrawingCanvas">üñäÔ∏è</button>
                        <button class="tool-btn" data-tool="eraser" data-canvas="freeDrawingCanvas">üßΩ</button>
                        <button class="tool-btn" data-size="3" data-canvas="freeDrawingCanvas">‚ö™</button>
                        <button class="tool-btn active" data-size="5" data-canvas="freeDrawingCanvas">üîµ</button>
                        <button class="tool-btn" data-size="10" data-canvas="freeDrawingCanvas">üî¥</button>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn back" onclick="showMenu()">üè† –ú–µ–Ω—é</button>
                    <button class="btn" onclick="clearCanvas('free')">üóëÔ∏è</button>
                    <button class="btn undo" onclick="undoCanvas('free')">‚Ü©Ô∏è</button>
                    <button class="btn redo" onclick="redoCanvas('free')">‚Ü™Ô∏è</button>
                </div>
            </div>
        </div>
        
        <div id="final-screen" class="hidden">
            <div class="final-score">
                <h2>üéâ –ú–æ–ª–æ–¥–µ—Ü—å!</h2>
                <p>–¢–≤—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span id="final-score-text"></span></p>
                <p id="final-message"></p>
            </div>
            <div class="controls">
                <button class="btn back" onclick="showMenu()">üè† –ú–µ–Ω—é</button>
                <button class="btn restart" onclick="restartCurrentGame()">üîÑ –©–µ —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <script>
        // –î–∞–Ω—ñ –¥–ª—è –≥—Ä–∏
        const emotions = [
            { emoji: 'üòä', name: '–†–∞–¥—ñ—Å—Ç—å', options: ['–†–∞–¥—ñ—Å—Ç—å', '–°—É–º', '–ó–ª—ñ—Å—Ç—å', '–°—Ç—Ä–∞—Ö'] },
            { emoji: 'üò¢', name: '–°—É–º', options: ['–†–∞–¥—ñ—Å—Ç—å', '–°—É–º', '–ó–¥–∏–≤—É–≤–∞–Ω–Ω—è', '–ó–ª—ñ—Å—Ç—å'] },
            { emoji: 'üò†', name: '–ó–ª—ñ—Å—Ç—å', options: ['–°—É–º', '–†–∞–¥—ñ—Å—Ç—å', '–ó–ª—ñ—Å—Ç—å', '–°—Ç—Ä–∞—Ö'] },
            { emoji: 'üò®', name: '–°—Ç—Ä–∞—Ö', options: ['–ó–ª—ñ—Å—Ç—å', '–†–∞–¥—ñ—Å—Ç—å', '–°—Ç—Ä–∞—Ö', '–°—É–º'] },
            { emoji: 'üòÆ', name: '–ó–¥–∏–≤—É–≤–∞–Ω–Ω—è', options: ['–ó–¥–∏–≤—É–≤–∞–Ω–Ω—è', '–†–∞–¥—ñ—Å—Ç—å', '–°—É–º', '–ó–ª—ñ—Å—Ç—å'] },
            { emoji: 'üò¥', name: '–í—Ç–æ–º–∞', options: ['–†–∞–¥—ñ—Å—Ç—å', '–í—Ç–æ–º–∞', '–ó–ª—ñ—Å—Ç—å', '–°—Ç—Ä–∞—Ö'] },
            { emoji: 'ü§î', name: '–†–æ–∑–¥—É–º–∏', options: ['–†–æ–∑–¥—É–º–∏', '–°—É–º', '–†–∞–¥—ñ—Å—Ç—å', '–ó–ª—ñ—Å—Ç—å'] },
            { emoji: 'üòç', name: '–ó–∞–∫–æ—Ö–∞–Ω—ñ—Å—Ç—å', options: ['–ó–ª—ñ—Å—Ç—å', '–ó–∞–∫–æ—Ö–∞–Ω—ñ—Å—Ç—å', '–°—Ç—Ä–∞—Ö', '–°—É–º'] },
            { emoji: 'ü§ó', name: '–ù—ñ–∂–Ω—ñ—Å—Ç—å', options: ['–ù—ñ–∂–Ω—ñ—Å—Ç—å', '–ó–ª—ñ—Å—Ç—å', '–°—Ç—Ä–∞—Ö', '–°—É–º'] },
            { emoji: 'üò§', name: '–û–±—É—Ä–µ–Ω–Ω—è', options: ['–†–∞–¥—ñ—Å—Ç—å', '–°—É–º', '–û–±—É—Ä–µ–Ω–Ω—è', '–°—Ç—Ä–∞—Ö'] }
        ];
        
        const alphabet = [
            { letter: '–ê', name: '–ê', options: ['–ê', '–û', '–£', '–Ü'] },
            { letter: '–ë', name: '–ë', options: ['–ë', '–í', '–ì', '–î'] },
            { letter: '–í', name: '–í', options: ['–í', '–ë', '–ì', '–ñ'] },
            { letter: '–ì', name: '–ì', options: ['–ì', '“ê', '–î', '–ï'] },
            { letter: '–î', name: '–î', options: ['–î', '–ë', '–ó', '–ö'] },
            { letter: '–ï', name: '–ï', options: ['–ï', '–Ñ', '–Ü', '–ê'] },
            { letter: '–ñ', name: '–ñ', options: ['–ñ', '–ó', '–•', '–®'] },
            { letter: '–ó', name: '–ó', options: ['–ó', '–°', '–ñ', '–ß'] },
            { letter: '–Ü', name: '–Ü', options: ['–Ü', '–á', '–ô', '–£'] },
            { letter: '–ö', name: '–ö', options: ['–ö', '–•', '–†', '–ü'] },
            { letter: '–õ', name: '–õ', options: ['–õ', '–ú', '–ù', '–ö'] },
            { letter: '–ú', name: '–ú', options: ['–ú', '–ù', '–õ', '–ü'] },
            { letter: '–ù', name: '–ù', options: ['–ù', '–ú', '–†', '–û'] },
            { letter: '–û', name: '–û', options: ['–û', '–ê', '–£', '–ò'] },
            { letter: '–ü', name: '–ü', options: ['–ü', '–†', '–°', '–¢'] },
            { letter: '–†', name: '–†', options: ['–†', '–ü', '–°', '–§'] },
            { letter: '–°', name: '–°', options: ['–°', '–¢', '–†', '–ù'] },
            { letter: '–¢', name: '–¢', options: ['–¢', '–£', '–§', '–•'] },
            { letter: '–£', name: '–£', options: ['–£', '–Æ', '–Ø', '–ò'] },
            { letter: '–§', name: '–§', options: ['–§', '–•', '–¶', '–ß'] },
            { letter: '–•', name: '–•', options: ['–•', '–¶', '–®', '–©'] },
            { letter: '–¶', name: '–¶', options: ['–¶', '–ß', '–®', '–©'] },
            { letter: '–ß', name: '–ß', options: ['–ß', '–¶', '–®', '–©'] },
            { letter: '–®', name: '–®', options: ['–®', '–©', '–¨', '–Æ'] },
            { letter: '–©', name: '–©', options: ['–©', '–¨', '–Æ', '–Ø'] },
            { letter: '–¨', name: '–¨', options: ['–¨', '–Æ', '–Ø', '–ê'] },
            { letter: '–Æ', name: '–Æ', options: ['–Æ', '–Ø', '–ê', '–û'] },
            { letter: '–Ø', name: '–Ø', options: ['–Ø', '–ê', '–ï', '–Ü'] }
        ];
        
        const numbers = [
            { number: '1', name: '1', options: ['1', '2', '3', '4'] },
            { number: '2', name: '2', options: ['2', '1', '3', '5'] },
            { number: '3', name: '3', options: ['3', '2', '4', '8'] },
            { number: '4', name: '4', options: ['4', '1', '7', '9'] },
            { number: '5', name: '5', options: ['5', '2', '6', '8'] },
            { number: '6', name: '6', options: ['6', '9', '5', '0'] },
            { number: '7', name: '7', options: ['7', '1', '4', '9'] },
            { number: '8', name: '8', options: ['8', '0', '3', '6'] },
            { number: '9', name: '9', options: ['9', '6', '8', '4'] },
            { number: '0', name: '0', options: ['0', '8', '6', '9'] }
        ];
        
        const drawingLetters = ['–ê', '–ë', '–í', '–ì', '–î', '–ï', '–Ñ', '–ñ', '–ó', '–ò', '–Ü', '–á', '–ô', '–ö', '–õ', '–ú', '–ù', '–û', '–ü', '–†', '–°', '–¢', '–£', '–§', '–•', '–¶', '–ß', '–®', '–©', '–¨', '–Æ', '–Ø'];
        
        // –ó–º—ñ–Ω–Ω—ñ –≥—Ä–∏
        let currentGame = '';
        let currentQuestion = 0;
        let score = 0;
        let answered = false;
        let currentDrawingNumberIndex = 0; 
        let currentDrawingLetterIndex = 0; 
        
        // –ö–∞–Ω–≤–∞—Å –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è —Ü–∏—Ñ—Ä
        let numberCanvas, numberCtx;
        let currentNumberColor = '#000000';
        let currentNumberBrushSize = 5; 
        let currentNumberTool = 'pen'; 
        let numberUndoStack = []; 
        let numberRedoStack = []; 

        // –ö–∞–Ω–≤–∞—Å –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è –ª—ñ—Ç–µ—Ä
        let letterCanvas, letterCtx;
        let currentLetterColor = '#000000';
        let currentLetterBrushSize = 5; 
        let currentLetterTool = 'pen'; 
        let letterUndoStack = [];
        let letterRedoStack = [];

        // –ö–∞–Ω–≤–∞—Å –¥–ª—è –≤—ñ–ª—å–Ω–æ–≥–æ –º–∞–ª—é–≤–∞–Ω–Ω—è
        let freeCanvas, freeCtx;
        let currentFreeColor = '#000000';
        let currentFreeBrushSize = 5; 
        let currentFreeTool = 'pen'; 
        let freeUndoStack = [];
        let freeRedoStack = [];

        const MAX_UNDO_STATES = 10; 
        
        // --- –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Å–∏–Ω—Ç–µ–∑—É –º–æ–≤–ª–µ–Ω–Ω—è ---
        let speechSynth = window.speechSynthesis;
        let ukrainianVoice = null;

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≥–æ–ª–æ—Å, –∫–æ–ª–∏ –≤—ñ–Ω —Å—Ç–∞–Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–º
        speechSynth.onvoiceschanged = () => {
            const voices = speechSynth.getVoices();
            ukrainianVoice = voices.find(voice => voice.lang === 'uk-UA' || voice.name.includes('Ukrainian'));
            if (!ukrainianVoice) {
                console.warn('–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≥–æ–ª–æ—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ë—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –≥–æ–ª–æ—Å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.');
            }
        };

        function speakText(text) {
            if (!speechSynth) {
                console.error('API —Å–∏–Ω—Ç–µ–∑—É –º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'uk-UA'; // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É
            if (ukrainianVoice) {
                utterance.voice = ukrainianVoice;
            } else {
                // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–∞–π—Ç–∏ –≥–æ–ª–æ—Å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó, —è–∫—â–æ ukrainianVoice –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                const voices = speechSynth.getVoices();
                utterance.voice = voices.find(voice => voice.lang.startsWith('uk')) || voices.find(voice => voice.default);
            }
            
            // –Ø–∫—â–æ –≤–∂–µ —â–æ—Å—å –≥–æ–≤–æ—Ä–∏—Ç—å—Å—è, –∑—É–ø–∏–Ω—è—î–º–æ –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –Ω–æ–≤–æ–≥–æ
            if (speechSynth.speaking) {
                speechSynth.cancel();
            }
            speechSynth.speak(utterance);
        }

        // --- –ö—ñ–Ω–µ—Ü—å —Ñ—É–Ω–∫—Ü—ñ–π –¥–ª—è —Å–∏–Ω—Ç–µ–∑—É –º–æ–≤–ª–µ–Ω–Ω—è ---


        function getCanvasState(canvas) {
            return canvas.toDataURL();
        }

        function restoreCanvasState(canvas, ctx, state) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = state;
        }

        function saveCanvasState(type) {
            let canvas, undoStack, redoStack;
            if (type === 'number') {
                canvas = numberCanvas;
                undoStack = numberUndoStack;
                redoStack = numberRedoStack;
            } else if (type === 'letter') {
                canvas = letterCanvas;
                undoStack = letterUndoStack;
                redoStack = letterRedoStack;
            } else if (type === 'free') {
                canvas = freeCanvas;
                undoStack = freeUndoStack;
                redoStack = freeRedoStack;
            }

            if (!canvas) return;

            // Clear redo stack on new action
            redoStack.length = 0;

            undoStack.push(getCanvasState(canvas));
            if (undoStack.length > MAX_UNDO_STATES) {
                undoStack.shift(); 
            }
        }

        function undoCanvas(type) {
            let canvas, ctx, undoStack, redoStack;
            if (type === 'number') {
                canvas = numberCanvas;
                ctx = numberCtx;
                undoStack = numberUndoStack;
                redoStack = numberRedoStack;
            } else if (type === 'letter') {
                canvas = letterCanvas;
                ctx = letterCtx;
                undoStack = letterUndoStack;
                redoStack = letterRedoStack;
            } else if (type === 'free') {
                canvas = freeCanvas;
                ctx = freeCtx;
                undoStack = freeUndoStack;
                redoStack = freeRedoStack;
            }

            if (undoStack.length > 1) { 
                const lastState = undoStack.pop();
                redoStack.push(lastState); 
                restoreCanvasState(canvas, ctx, undoStack[undoStack.length - 1]);
            } else if (undoStack.length === 1) { 
                redoStack.push(undoStack.pop()); 
                clearCanvas(type, false); 
                saveCanvasState(type); 
            }
        }

        function redoCanvas(type) {
            let canvas, ctx, undoStack, redoStack;
            if (type === 'number') {
                canvas = numberCanvas;
                ctx = numberCtx;
                undoStack = numberUndoStack;
                redoStack = numberRedoStack;
            } else if (type === 'letter') {
                canvas = letterCanvas;
                ctx = letterCtx;
                undoStack = letterUndoStack;
                redoStack = letterRedoStack;
            } else if (type === 'free') {
                canvas = freeCanvas;
                ctx = freeCtx;
                undoStack = freeUndoStack;
                redoStack = freeRedoStack;
            }

            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                undoStack.push(nextState);
                restoreCanvasState(canvas, ctx, nextState);
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        function showMenu() {
            document.querySelectorAll('.game-content, #final-screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('main-menu').classList.remove('hidden');
        }
        
        function startGame(gameType) {
            currentGame = gameType;
            currentQuestion = 0;
            score = 0;
            answered = false;
            
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('final-screen').classList.add('hidden');
            
            if (gameType === 'emotions') {
                gameData = shuffleArray(emotions).slice(0, 8); 
                document.getElementById('emotions-game').classList.remove('hidden');
                showEmotionQuestion();
            } else if (gameType === 'alphabet') {
                gameData = shuffleArray(alphabet).slice(0, 8); 
                document.getElementById('alphabet-game').classList.remove('hidden');
                showAlphabetQuestion();
            } else if (gameType === 'numbers') {
                gameData = shuffleArray(numbers).slice(0, 8); 
                document.getElementById('numbers-game').classList.remove('hidden');
                showNumberQuestion();
            } else if (gameType === 'drawing') {
                document.getElementById('drawing-game').classList.remove('hidden');
                initDrawingCanvas('number');
                currentDrawingNumberIndex = 0; 
                showDrawingNumber();
            } else if (gameType === 'letter-drawing') { 
                document.getElementById('letter-drawing-game').classList.remove('hidden');
                initDrawingCanvas('letter');
                currentDrawingLetterIndex = 0; 
                showDrawingLetter();
            } else if (gameType === 'free-drawing') { 
                document.getElementById('free-drawing-game').classList.remove('hidden');
                initDrawingCanvas('free');
            }
        }
        
        function showEmotionQuestion() {
            if (currentQuestion >= gameData.length) {
                showFinalScreen();
                return;
            }
            
            answered = false;
            const question = gameData[currentQuestion];
            
            document.getElementById('emotion-emoji').textContent = question.emoji;
            document.getElementById('emotions-score').textContent = score;
            document.getElementById('emotions-total').textContent = gameData.length; 
            
            const optionsContainer = document.getElementById('emotions-options');
            optionsContainer.innerHTML = '';
            
            const shuffledOptions = shuffleArray(question.options);
            
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(option, question.name, button, 'emotions');
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('emotions-feedback').classList.add('hidden');
            document.getElementById('emotions-next').classList.add('hidden');
        }
        
        function showAlphabetQuestion() {
            if (currentQuestion >= gameData.length) {
                showFinalScreen();
                return;
            }
            
            answered = false;
            const question = gameData[currentQuestion];
            
            document.getElementById('letter-display').textContent = question.letter;
            document.getElementById('alphabet-score').textContent = score;
            document.getElementById('alphabet-total').textContent = gameData.length; 
            
            const optionsContainer = document.getElementById('alphabet-options');
            optionsContainer.innerHTML = '';
            
            const shuffledOptions = shuffleArray(question.options);
            
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(option, question.name, button, 'alphabet');
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('alphabet-feedback').classList.add('hidden');
            document.getElementById('alphabet-next').classList.add('hidden');
        }
        
        function showNumberQuestion() {
            if (currentQuestion >= gameData.length) {
                showFinalScreen();
                return;
            }
            
            answered = false;
            const question = gameData[currentQuestion];
            
            document.getElementById('number-display').textContent = question.number;
            document.getElementById('numbers-score').textContent = score;
            document.getElementById('numbers-total').textContent = gameData.length; 
            
            const optionsContainer = document.getElementById('numbers-options');
            optionsContainer.innerHTML = '';
            
            const shuffledOptions = shuffleArray(question.options);
            
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(option, question.name, button, 'numbers');
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('numbers-feedback').classList.add('hidden');
            document.getElementById('numbers-next').classList.add('hidden');
        }
        
        function selectOption(selected, correct, buttonElement, gameType) {
            if (answered) return;
            answered = true;

            const buttons = document.querySelectorAll(`#${gameType}-options .option-btn`);
            buttons.forEach(btn => btn.style.pointerEvents = 'none'); 

            const feedback = document.getElementById(`${gameType}-feedback`);
            
            if (selected === correct) {
                score++;
                buttonElement.classList.add('correct');
                feedback.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü—å! üéâ';
                feedback.className = 'feedback correct';
            } else {
                buttonElement.classList.add('wrong');
                buttons.forEach(btn => {
                    if (btn.textContent === correct) {
                        btn.classList.add('correct'); 
                    }
                });
                feedback.textContent = `–ù–µ –∑–æ–≤—Å—ñ–º. –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${correct} ü§î`;
                feedback.className = 'feedback wrong';
            }
            
            feedback.classList.remove('hidden');
            document.getElementById(`${gameType}-next`).classList.remove('hidden');
            document.getElementById(`${gameType}-score`).textContent = score;
        }
        
        function nextQuestion() {
            currentQuestion++;
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.style.pointerEvents = 'auto';
                btn.classList.remove('correct', 'wrong');
            });
            
            if (currentGame === 'emotions') {
                showEmotionQuestion();
            } else if (currentGame === 'alphabet') {
                showAlphabetQuestion();
            } else if (currentGame === 'numbers') {
                showNumberQuestion();
            }
            if (document.getElementById(`${currentGame}-score`)) {
                document.getElementById(`${currentGame}-score`).textContent = score;
            }
        }
        
        function showFinalScreen() {
            document.querySelectorAll('.game-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('final-screen').classList.remove('hidden');
            
            const percentage = Math.round((score / gameData.length) * 100);
            document.getElementById('final-score-text').textContent = `${score} –∑ ${gameData.length} (${percentage}%)`;
            
            const messageElement = document.getElementById('final-message');
            if (percentage >= 80) {
                messageElement.textContent = '–§–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω–æ! –¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –µ–∫—Å–ø–µ—Ä—Ç! üåü';
            } else if (percentage >= 60) {
                messageElement.textContent = '–î–æ–±—Ä–µ! –¢–∏ –º–æ–ª–æ–¥–µ—Ü—å! üëç';
            } else {
                messageElement.textContent = '–ù–µ –∑–∞—Å–º—É—á—É–π—Å—è! –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑! üí™';
            }
        }
        
        function restartCurrentGame() {
            startGame(currentGame);
        }
        
        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è
        function initDrawingCanvas(type) {
            let canvas, ctx, defaultColor, defaultBrushSize, undoStack, redoStack;

            if (type === 'number') {
                canvas = document.getElementById('drawingCanvas');
                ctx = canvas.getContext('2d');
                numberCanvas = canvas; 
                numberCtx = ctx;
                defaultColor = currentNumberColor;
                defaultBrushSize = currentNumberBrushSize;
                undoStack = numberUndoStack;
                redoStack = numberRedoStack;
            } else if (type === 'letter') {
                canvas = document.getElementById('letterDrawingCanvas');
                ctx = canvas.getContext('2d');
                letterCanvas = canvas; 
                letterCtx = ctx;
                defaultColor = currentLetterColor;
                defaultBrushSize = currentLetterBrushSize;
                undoStack = letterUndoStack;
                redoStack = letterRedoStack;
            } else if (type === 'free') { 
                canvas = document.getElementById('freeDrawingCanvas');
                ctx = canvas.getContext('2d');
                freeCanvas = canvas; 
                freeCtx = ctx;
                defaultColor = currentFreeColor;
                defaultBrushSize = currentFreeBrushSize;
                undoStack = freeUndoStack;
                redoStack = freeRedoStack;
            }
            
            resizeCanvas(canvas);
            setupDrawingEvents(canvas, ctx, type);
            ctx.lineWidth = defaultBrushSize; 
            ctx.strokeStyle = defaultColor; 
            
            clearCanvas(type, false); 
            undoStack.length = 0; 
            redoStack.length = 0; 
            saveCanvasState(type); 

            // Setup color buttons
            document.querySelectorAll(`.color-btn[data-canvas="${canvas.id}"]`).forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll(`.color-btn[data-canvas="${canvas.id}"]`).forEach(activeBtn => activeBtn.classList.remove('active'));
                    btn.classList.add('active');
                    if (type === 'number') {
                        currentNumberColor = btn.dataset.color;
                        currentNumberTool = 'pen'; 
                        numberCtx.strokeStyle = currentNumberColor;
                    } else if (type === 'letter') {
                        currentLetterColor = btn.dataset.color;
                        currentLetterTool = 'pen'; 
                        letterCtx.strokeStyle = currentLetterColor;
                    } else if (type === 'free') {
                        currentFreeColor = btn.dataset.color;
                        currentFreeTool = 'pen'; 
                        freeCtx.strokeStyle = currentFreeColor;
                    }
                    document.querySelector(`.tool-btn[data-canvas="${canvas.id}"][data-tool="pen"]`).classList.add('active');
                    document.querySelector(`.tool-btn[data-canvas="${canvas.id}"][data-tool="eraser"]`).classList.remove('active');

                };
            });

            // Setup tool buttons (pen, eraser)
            document.querySelectorAll(`.tool-btn[data-canvas="${canvas.id}"][data-tool]`).forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll(`.tool-btn[data-canvas="${canvas.id}"][data-tool]`).forEach(activeBtn => activeBtn.classList.remove('active'));
                    btn.classList.add('active');
                    const tool = btn.dataset.tool;
                    if (type === 'number') {
                        currentNumberTool = tool;
                        numberCtx.strokeStyle = (tool === 'eraser') ? 'white' : currentNumberColor;
                    } else if (type === 'letter') {
                        currentLetterTool = tool;
                        letterCtx.strokeStyle = (tool === 'eraser') ? 'white' : currentLetterColor;
                    } else if (type === 'free') {
                        currentFreeTool = tool;
                        freeCtx.strokeStyle = (tool === 'eraser') ? 'white' : currentFreeColor;
                    }
                };
            });

            // Setup size buttons
            document.querySelectorAll(`.tool-btn[data-canvas="${canvas.id}"][data-size]`).forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll(`.tool-btn[data-canvas="${canvas.id}"][data-size]`).forEach(activeBtn => activeBtn.classList.remove('active'));
                    btn.classList.add('active');
                    const size = parseInt(btn.dataset.size);
                    if (type === 'number') {
                        currentNumberBrushSize = size;
                        numberCtx.lineWidth = currentNumberBrushSize;
                    } else if (type === 'letter') {
                        currentLetterBrushSize = size;
                        letterCtx.lineWidth = currentLetterBrushSize;
                    } else if (type === 'free') {
                        currentFreeBrushSize = size;
                        freeCtx.lineWidth = currentFreeBrushSize;
                    }
                };
            });

            document.querySelector(`.tool-btn[data-canvas="${canvas.id}"][data-tool="pen"]`).classList.add('active');
            document.querySelector(`.tool-btn[data-canvas="${canvas.id}"][data-size="5"]`).classList.add('active');
        }

        function setupDrawingEvents(canvas, ctx, type) {
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault(); 
                const { x, y } = getCanvasCoordinates(e, canvas);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            }

            function startDrawing(e) {
                e.preventDefault(); 
                isDrawing = true;
                const { x, y } = getCanvasCoordinates(e, canvas);
                [lastX, lastY] = [x, y];
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            function stopDrawing() {
                if (isDrawing) { 
                    saveCanvasState(type);
                }
                isDrawing = false;
                ctx.closePath();
            }
            
            canvas.removeEventListener('mousedown', startDrawing);
            canvas.removeEventListener('mousemove', draw);
            canvas.removeEventListener('mouseup', stopDrawing);
            canvas.removeEventListener('mouseout', stopDrawing);
            canvas.removeEventListener('touchstart', startDrawing);
            canvas.removeEventListener('touchmove', draw);
            canvas.removeEventListener('touchend', stopDrawing);

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
        }

        function resizeCanvas(canvas) {
            const container = canvas.closest('.drawing-container');
            if (container) {
                const containerWidth = container.offsetWidth;
                const canvasHeight = Math.min(containerWidth * 0.75, 400); 
                canvas.width = Math.min(containerWidth, 500); 
                canvas.height = canvasHeight;
            }
            let ctxToUse, colorToUse, brushSizeToUse, toolToUse;
            if (canvas.id === 'drawingCanvas' && numberCtx) {
                ctxToUse = numberCtx;
                colorToUse = currentNumberColor;
                brushSizeToUse = currentNumberBrushSize;
                toolToUse = currentNumberTool;
            } else if (canvas.id === 'letterDrawingCanvas' && letterCtx) {
                ctxToUse = letterCtx;
                colorToUse = currentLetterColor;
                brushSizeToUse = currentLetterBrushSize;
                toolToUse = currentLetterTool;
            } else if (canvas.id === 'freeDrawingCanvas' && freeCtx) {
                ctxToUse = freeCtx;
                colorToUse = currentFreeColor;
                brushSizeToUse = currentFreeBrushSize;
                toolToUse = currentFreeTool;
            } else {
                return; 
            }

            if (ctxToUse) {
                ctxToUse.lineCap = 'round';
                ctxToUse.lineJoin = 'round';
                ctxToUse.lineWidth = brushSizeToUse;
                ctxToUse.strokeStyle = (toolToUse === 'eraser') ? 'white' : colorToUse;
            }
        }
        
        function getCanvasCoordinates(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            let x, y;
            if (e.touches && e.touches.length > 0) { 
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else { 
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        function clearCanvas(type, saveNewState = true) {
            let canvas, ctx;
            if (type === 'number') {
                canvas = numberCanvas;
                ctx = numberCtx;
            } else if (type === 'letter') {
                canvas = letterCanvas;
                ctx = letterCtx;
            } else if (type === 'free') {
                canvas = freeCanvas;
                ctx = freeCtx;
            }

            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let color, brushSize, tool;
                if (type === 'number') {
                    color = currentNumberColor;
                    brushSize = currentNumberBrushSize;
                    tool = currentNumberTool;
                } else if (type === 'letter') {
                    color = currentLetterColor;
                    brushSize = currentLetterBrushSize;
                    tool = currentLetterTool;
                } else if (type === 'free') {
                    color = currentFreeColor;
                    brushSize = currentFreeBrushSize;
                    tool = currentFreeTool;
                }
                ctx.strokeStyle = (tool === 'eraser') ? 'white' : color;
                ctx.lineWidth = brushSize;
                if (saveNewState) {
                    saveCanvasState(type); 
                }
            }
        }

        function showDrawingNumber() {
            document.getElementById('draw-number').textContent = numbers[currentDrawingNumberIndex].number;
            clearCanvas('number'); 
            numberUndoStack = []; 
            numberRedoStack = []; 
            saveCanvasState('number');
        }

        function showDrawingLetter() {
            document.getElementById('draw-letter').textContent = drawingLetters[currentDrawingLetterIndex];
            clearCanvas('letter'); 
            letterUndoStack = []; 
            letterRedoStack = []; 
            saveCanvasState('letter');
        }

        function nextDrawingItem(type) {
            if (type === 'number') {
                currentDrawingNumberIndex++;
                if (currentDrawingNumberIndex >= numbers.length) {
                    currentDrawingNumberIndex = 0; 
                }
                showDrawingNumber();
            } else if (type === 'letter') {
                currentDrawingLetterIndex++;
                if (currentDrawingLetterIndex >= drawingLetters.length) {
                    currentDrawingLetterIndex = 0; 
                }
                showDrawingLetter();
            }
        }

        window.addEventListener('resize', () => {
            if (numberCanvas) resizeCanvas(numberCanvas);
            if (letterCanvas) resizeCanvas(letterCanvas);
            if (freeCanvas) resizeCanvas(freeCanvas);
        });

    </script>
</body>
</html>
